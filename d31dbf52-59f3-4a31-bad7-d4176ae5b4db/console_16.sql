select *
    --array_agg(cl.client_order_id)
    from consolidator.cons_lite_parent_to_rfr rfr
      --    left join dwh.client_order cl on cl.client_order_id = rfr.parent_client_order_id
where rfr_id in /*('180023654100',
'180023654753',
'280019678200',
'280019678351',
'280019678863',
'380019749634',
'380019749845',
'380019750650',
'380019750729',
'380019751045',
'680024719575',
'718024123294',
'718024127765',
'728024123334',
'738019324731',
'738019329031',
'748018550422',
'748018552898',
'758013890465',
'758013893642',
'758013894565',
'758013895702',
'758013896866',
'778005878031',
'778005878974',
'778005880825',
'778005882675',
'778005882813',
'788005926417',
'788005928635',
'788005929180',
'788005929196',
'798024809002'),*/
(
'180023661941',
'180023664110',
'180023664232',
'180023665057',
'180023665706',
'180023666820',
'280019682384',
'280019682721',
'280019683774',
'280019684385',
'280019686021',
'280019686137',
'280019686838',
'380019752192',
'380019755959',
'380019758321',
'680024722717',
'680024722928',
'680024726560',
'680024726740',
'718024128084',
'718024129725',
'718024130173',
'718024131479',
'718024134915',
'718024137623',
'718024138438',
'728024126909',
'728024127932',
'728024129973',
'728024130193',
'728024130591',
'728024130735',
'728024131245',
'728024134258',
'728024134368',
'728024134882',
'738019329971',
'738019330746',
'738019330944',
'738019333457',
'738019333621',
'738019334077',
'738019334085',
'738019334620',
'738019335044',
'738019335282',
'738019335597',
'738019336675',
'738019337669',
'738019337692',
'738019338835',
'738019339061',
'738019339095',
'738019339308',
'748018555018',
'748018557769',
'748018557902',
'748018559752',
'748018559977',
'748018560697',
'748018561725',
'748018561844',
'758013898709',
'758013899264',
'758013903038',
'758013903148',
'758013903283',
'758013905140',
'758013906097',
'758013906602',
'758013906782',
'758013908237',
'758013909213',
'768013760382',
'768013761240',
'768013762242',
'768013763197',
'768013763288',
'768013763880',
'768013765267',
'768013765490',
'768013765590',
'768013768182',
'768013768375',
'768013769804',
'768013770297',
'768013770460',
'768013770813',
'768013771057',
'768013771220',
'778005886988',
'778005889727',
'778005891860',
'778005892474',
'778005892593',
'788005931421',
'788005933665',
'788005934028',
'788005934620',
'788005935795',
'788005937098',
'788005937174',
'788005938170',
'788005938840',
'788005939709',
'798024811392',
'798024814112',
'798024814977',
'798024815875',
'798024817869',
'798024818519')


/*
         where rfr_id in ('180023654100',
'180023654753',
'280019678200',
'280019678351',
'280019678863',
'380019749634',
'380019749845',
'380019750650',
'380019750729',
'380019751045',
'680024719575',
'718024123294',
'718024127765',
'728024123334',
'738019324731',
'738019329031',
'748018550422',
'748018552898',
'758013890465',
'758013893642',
'758013894565',
'758013895702',
'758013896866',
'778005878031',
'778005878974',
'778005880825',
'778005882675',
'778005882813',
'788005926417',
'788005928635',
'788005929180',
'788005929196',
'798024809002')


 */

     select array_agg(account_id) from dwh.d_account ac
             join lateral (select
                           from dwh.d_trading_firm tf
                           where tf.trading_firm_id = ac.trading_firm_id
                             and tf.is_eligible4consolidator = 'Y'
                           limit 1) tf on true
    where true
      and (ac.date_start, coalesce(ac.date_end, '2399-01-01'::date)) overlaps
          (:f_day_1, :f_day_2)

select ex.order_id
 from dwh.execution ex
             join dwh.client_order cl on cl.order_id = ex.order_id and cl.account_id = any (:l_acc_ids)
             join dwh.d_instrument i on i.instrument_id = cl.instrument_id
             join dwh.d_account ac on (ac.account_id = cl.account_id)
             join lateral (select
                           from dwh.d_trading_firm tf
                           where tf.trading_firm_id = ac.trading_firm_id
                             and tf.is_eligible4consolidator = 'Y'
                           limit 1) tf on true
             join lateral (select fc.acceptor_id
                           from dwh.d_fix_connection fc
                           where fc.fix_connection_id = cl.fix_connection_id
                             and fc.fix_comp_id <> 'IMCCONS'
                           limit 1) fc on true
             left join lateral (select pro.order_type_id,
                                       pro.sub_strategy_id,
                                       pro.time_in_force_id,
                                       pro.client_order_id,
                                       pro.sub_strategy_desc
                                from dwh.client_order pro
                                where pro.order_id = cl.parent_order_id
                                  and pro.create_date_id = to_char(cl.parent_order_process_time, 'YYYYMMDD')::int4
                                limit 1) pro on true
             left join dwh.client_order str
                       on (str.parent_order_id = cl.order_id and str.client_order_id = ex.secondary_order_id
                           and ex.exec_type = 'F'
                           and str.create_date_id = to_char(:in_date::date, 'YYYYMMDD')::int
                           ) -- str.create_date_id = cl.create_date_id
             left join dwh.execution es on (es.order_id = str.order_id and es.exec_date_id = ex.exec_date_id and
                                            es.exch_exec_id = ex.secondary_exch_exec_id)
             left join dwh.d_option_contract oc on (oc.instrument_id = cl.instrument_id)
             left join dwh.d_option_series os on (os.option_series_id = oc.option_series_id)
             left join dwh.d_sub_system dss on dss.sub_system_unq_id = cl.sub_system_unq_id
    where true
      and ex.exec_time::date = :in_date::date
      and ex.exec_date_id = to_char(:in_date::date, 'YYYYMMDD')::int
      and cl.create_date_id = to_char(:in_date::date, 'YYYYMMDD')::int
      and cl.multileg_reporting_type in ('1','2')
      and ex.is_busted = 'N'
      and ex.exec_type not in ('E', 'S', 'D', 'y')
      and cl.trans_type <> 'F'
and cl.client_order_id = any('{"iko3_2460250_124755","abo2_2460250_204592","11924764887","uzo2_2460250_128167","11925849935"}');



select sub_strategy_desc, * from trash.cutler_extended
where
   --sub_strategy_desc ilike '%DNA%'
    rfr_rfr_id in
    ('180023654100',
'180023654753',
'280019678200',
'280019678351',
'280019678863',
'380019749634',
'380019749845',
'380019750650',
'380019750729',
'380019751045',
'680024719575',
'718024123294',
'718024127765',
'728024123334',
'738019324731',
'738019329031',
'748018550422',
'748018552898',
'758013890465',
'758013893642',
'758013894565',
'758013895702',
'758013896866',
'778005878031',
'778005878974',
'778005880825',
'778005882675',
'778005882813',
'788005926417',
'788005928635',
'788005929180',
'788005929196',
'798024809002')
    (
'180023661941',
'180023664110',
'180023664232',
'180023665057',
'180023665706',
'180023666820',
'280019682384',
'280019682721',
'280019683774',
'280019684385',
'280019686021',
'280019686137',
'280019686838',
'380019752192',
'380019755959',
'380019758321',
'680024722717',
'680024722928',
'680024726560',
'680024726740',
'718024128084',
'718024129725',
'718024130173',
'718024131479',
'718024134915',
'718024137623',
'718024138438',
'728024126909',
'728024127932',
'728024129973',
'728024130193',
'728024130591',
'728024130735',
'728024131245',
'728024134258',
'728024134368',
'728024134882',
'738019329971',
'738019330746',
'738019330944',
'738019333457',
'738019333621',
'738019334077',
'738019334085',
'738019334620',
'738019335044',
'738019335282',
'738019335597',
'738019336675',
'738019337669',
'738019337692',
'738019338835',
'738019339061',
'738019339095',
'738019339308',
'748018555018',
'748018557769',
'748018557902',
'748018559752',
'748018559977',
'748018560697',
'748018561725',
'748018561844',
'758013898709',
'758013899264',
'758013903038',
'758013903148',
'758013903283',
'758013905140',
'758013906097',
'758013906602',
'758013906782',
'758013908237',
'758013909213',
'768013760382',
'768013761240',
'768013762242',
'768013763197',
'768013763288',
'768013763880',
'768013765267',
'768013765490',
'768013765590',
'768013768182',
'768013768375',
'768013769804',
'768013770297',
'768013770460',
'768013770813',
'768013771057',
'768013771220',
'778005886988',
'778005889727',
'778005891860',
'778005892474',
'778005892593',
'788005931421',
'788005933665',
'788005934028',
'788005934620',
'788005935795',
'788005937098',
'788005937174',
'788005938170',
'788005938840',
'788005939709',
'798024811392',
'798024814112',
'798024814977',
'798024815875',
'798024817869',
'798024818519')


    select 1/0